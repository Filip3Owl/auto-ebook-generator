import streamlit as st
from langchain.llms import OpenAI
import sys
from pathlib import Path
from PIL import Image
import base64
import json
from datetime import datetime
import traceback

# Configura paths para imports
sys.path.append(str(Path(__file__).parent))

# Importa√ß√µes locais
from core.prompts import EBOOK_PROMPTS
from agents.outline import create_outline_chain
from agents.writer import create_writing_chain
from utils.file_io import save_ebook
from utils.config import load_config

# Configura√ß√£o inicial
load_config()

def apply_dark_theme():
    """
    Aplica tema escuro personalizado para fundo preto
    """
    st.markdown("""
    <style>
        /* Reset e configura√ß√µes globais */
        .stApp {
            background-color: #0e1117;
            color: #ffffff;
        }
        
        /* Header personalizado */
        .main-header {
            font-size: 3.5em;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }
        
        .sub-header {
            font-size: 1.3em;
            color: #8b92a5;
            text-align: center;
            margin-bottom: 40px;
            font-weight: 300;
        }
        
        /* Sidebar styling */
        .css-1d391kg {
            background-color: #1a1d29;
            border-right: 2px solid #2d3748;
        }
        
        .sidebar .sidebar-content {
            background-color: #1a1d29;
            color: #ffffff;
        }
        
        /* Cards e containers */
        .custom-card {
            background: linear-gradient(145deg, #1e2139, #2d3748);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #4a5568;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .feature-card {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #667eea40;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2);
            border-color: #667eea80;
        }
        
        /* Bot√µes personalizados */
        .stButton > button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stButton > button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a6fd8, #6b42a0);
        }
        
        /* Form inputs */
        .stTextInput > div > div > input,
        .stTextArea > div > div > textarea,
        .stSelectbox > div > div > select {
            background-color: #2d3748;
            color: #ffffff;
            border: 2px solid #4a5568;
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s ease;
        }
        
        .stTextInput > div > div > input:focus,
        .stTextArea > div > div > textarea:focus,
        .stSelectbox > div > div > select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Progress bar */
        .stProgress > div > div > div {
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        /* Success/Error messages */
        .stSuccess {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            color: white;
        }
        
        .stError {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            border-radius: 10px;
            color: white;
        }
        
        .stWarning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            border-radius: 10px;
            color: white;
        }
        
        .stInfo {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 10px;
            color: white;
        }
        
        /* Expander styling */
        .streamlit-expanderHeader {
            background-color: #2d3748;
            border-radius: 10px;
            color: #ffffff;
            font-weight: 600;
        }
        
        .streamlit-expanderContent {
            background-color: #1a1d29;
            border-radius: 0 0 10px 10px;
        }
        
        /* Tabs styling */
        .stTabs [data-baseweb="tab-list"] {
            gap: 8px;
        }
        
        .stTabs [data-baseweb="tab"] {
            background-color: #2d3748;
            border-radius: 10px 10px 0 0;
            color: #8b92a5;
            font-weight: 600;
        }
        
        .stTabs [aria-selected="true"] {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        /* Slider customization */
        .stSlider > div > div > div > div {
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        /* Radio buttons */
        .stRadio > div {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 15px;
        }
        
        /* Metrics styling */
        .metric-card {
            background: linear-gradient(145deg, #1e2139, #2d3748);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid #4a5568;
            margin: 10px 0;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .metric-label {
            color: #8b92a5;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        /* Animation classes */
        .fade-in {
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Glassmorphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            margin: 20px 0;
        }
        
        /* Loading spinner */
        .custom-spinner {
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Scrollbar customization */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1d29;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6b42a0);
        }
    </style>
    """, unsafe_allow_html=True)

def create_header():
    """Cria o cabe√ßalho principal"""
    st.markdown("""
    <div class="fade-in">
        <div class="main-header">üìö EBook Generator Pro</div>
        <div class="sub-header">Transforme suas ideias em ebooks profissionais com intelig√™ncia artificial</div>
    </div>
    """, unsafe_allow_html=True)

def create_sidebar():
    """Cria a sidebar com configura√ß√µes"""
    with st.sidebar:
        # Logo e t√≠tulo da sidebar
        st.markdown("""
        <div style="text-align: center; padding: 20px 0;">
            <div style="font-size: 4em;">‚öôÔ∏è</div>
            <h2 style="color: #667eea; margin: 10px 0;">Configura√ß√µes</h2>
        </div>
        """, unsafe_allow_html=True)
        
        # Configura√ß√£o da API Key
        with st.expander("üîë Configura√ß√£o da API", expanded=True):
            api_key = st.text_input(
                "OpenAI API Key",
                type="password",
                value=st.session_state.get("api_key", ""),
                help="Obtenha sua chave em platform.openai.com",
                placeholder="sk-..."
            )
            st.session_state.api_key = api_key or None
            
            if api_key:
                st.success("‚úÖ API Key configurada!")
            else:
                st.warning("‚ö†Ô∏è API Key necess√°ria")
        
        # Configura√ß√µes do ebook
        with st.expander("üìñ Configura√ß√µes do Ebook", expanded=True):
            # Tipo de livro
            book_type = st.selectbox(
                "Tipo de Livro",
                ["üìà Neg√≥cios", "üõ†Ô∏è T√©cnico", "üí° Autoajuda", "üéì Educacional", "üìù Narrativo"],
                index=0,
                help="Selecione o tipo de ebook para otimiza√ß√£o"
            )
            
            # Estilo de escrita
            style_options = {
                "üìà Neg√≥cios": ["Executivo", "Estrat√©gico", "Pr√°tico", "Anal√≠tico"],
                "üõ†Ô∏è T√©cnico": ["Did√°tico", "Profissional", "Detalhado", "Cient√≠fico"],
                "üí° Autoajuda": ["Inspiracional", "Motivacional", "Emp√°tico", "Transformador"],
                "üéì Educacional": ["Did√°tico", "Claro", "Estruturado", "Progressivo"],
                "üìù Narrativo": ["Envolvente", "Descritivo", "Criativo", "Emocional"]
            }
            
            ebook_style = st.selectbox(
                "Estilo de Escrita",
                style_options[book_type],
                help="Tom e abordagem do conte√∫do"
            )
            
            # Tamanho do ebook (at√© 200 p√°ginas)
            ebook_pages = st.slider(
                "üìÑ N√∫mero de P√°ginas",
                min_value=5,
                max_value=200,
                value=25,
                step=5,
                help="Tamanho aproximado do ebook"
            )
            
            # Estimativa de palavras
            estimated_words = ebook_pages * 250  # ~250 palavras por p√°gina
            st.info(f"üìä Estimativa: ~{estimated_words:,} palavras")
            
            # Idioma
            language = st.selectbox(
                "üåç Idioma",
                ["üáßüá∑ Portugu√™s", "üá∫üá∏ Ingl√™s", "üá™üá∏ Espanhol", "üá´üá∑ Franc√™s"],
                index=0
            )
        
        # Op√ß√µes de formato
        with st.expander("üíæ Formato de Sa√≠da"):
            output_format = st.radio(
                "Escolha o formato:",
                ["üìÑ PDF", "üìù Markdown", "üåê HTML", "üìä EPUB"],
                index=0,
                horizontal=False
            )
            
            include_images = st.checkbox(
                "üñºÔ∏è Incluir sugest√µes de imagens",
                value=True,
                help="Adiciona descri√ß√µes de imagens relevantes"
            )
            
            include_exercises = st.checkbox(
                "‚úèÔ∏è Incluir exerc√≠cios pr√°ticos",
                value=True,
                help="Adiciona atividades e reflex√µes"
            )
        
        # Estat√≠sticas da sess√£o
        st.markdown("---")
        st.markdown("### üìä Estat√≠sticas")
        
        col1, col2 = st.columns(2)
        with col1:
            st.metric(
                "Ebooks Gerados",
                st.session_state.get("ebooks_generated", 0),
                delta=None
            )
        with col2:
            st.metric(
                "P√°ginas Totais",
                st.session_state.get("total_pages", 0),
                delta=None
            )
        
        return {
            "api_key": api_key,
            "book_type": book_type,
            "style": ebook_style,
            "pages": ebook_pages,
            "language": language,
            "format": output_format,
            "include_images": include_images,
            "include_exercises": include_exercises
        }

def create_main_form():
    """Cria o formul√°rio principal"""
    st.markdown('<div class="custom-card fade-in">', unsafe_allow_html=True)
    
    with st.form("ebook_form", clear_on_submit=False):
        # T√≠tulo do t√≥pico
        st.markdown("### üí≠ Sobre o que ser√° seu ebook?")
        ebook_topic = st.text_area(
            "",
            placeholder="üìù Exemplo:\n‚Ä¢ Intelig√™ncia Artificial para Iniciantes\n‚Ä¢ Marketing Digital para Pequenas Empresas\n‚Ä¢ Guia Completo de Investimentos\n‚Ä¢ Hist√≥ria do Brasil Contempor√¢neo",
            height=120,
            help="Seja espec√≠fico sobre o tema principal"
        )
        
        # Op√ß√µes avan√ßadas
        with st.expander("üéØ Op√ß√µes Avan√ßadas", expanded=False):
            col1, col2 = st.columns(2)
            
            with col1:
                target_audience = st.text_input(
                    "üë• P√∫blico-alvo",
                    value="Adultos interessados no tema",
                    help="Ex: Profissionais de TI, Estudantes, Empreendedores"
                )
                
                difficulty_level = st.selectbox(
                    "üìä N√≠vel de Dificuldade",
                    ["Iniciante", "Intermedi√°rio", "Avan√ßado", "Especialista"],
                    index=1
                )
            
            with col2:
                tone = st.selectbox(
                    "üé≠ Tom do Conte√∫do",
                    ["Formal", "Conversacional", "T√©cnico", "Inspiracional"],
                    index=1
                )
                
                focus_area = st.selectbox(
                    "üéØ Foco Principal",
                    ["Te√≥rico", "Pr√°tico", "Balanceado", "Case Studies"],
                    index=2
                )
            
            key_points = st.text_area(
                "üìã Pontos-chave para incluir",
                placeholder="‚Ä¢ Conceitos fundamentais\n‚Ä¢ Exemplos pr√°ticos\n‚Ä¢ Dicas de implementa√ß√£o\n‚Ä¢ Erros comuns a evitar",
                height=100,
                help="Liste os principais t√≥picos que devem ser abordados"
            )
            
            special_requirements = st.text_area(
                "‚≠ê Requisitos Especiais",
                placeholder="‚Ä¢ Incluir estat√≠sticas atuais\n‚Ä¢ Focar em mercado brasileiro\n‚Ä¢ Adicionar templates\n‚Ä¢ Casos de sucesso reais",
                height=80,
                help="Requisitos espec√≠ficos ou prefer√™ncias especiais"
            )
        
        # Bot√£o de gera√ß√£o
        st.markdown("<br>", unsafe_allow_html=True)
        submit_button = st.form_submit_button(
            "‚ú® Gerar Ebook Profissional",
            use_container_width=True
        )
    
    st.markdown('</div>', unsafe_allow_html=True)
    
    return {
        "topic": ebook_topic,
        "audience": target_audience,
        "difficulty": difficulty_level,
        "tone": tone,
        "focus": focus_area,
        "key_points": key_points,
        "special_requirements": special_requirements,
        "submit": submit_button
    }

def create_example_section():
    """Cria se√ß√£o com exemplos e dicas"""
    st.markdown("""
    <div class="glass-card fade-in">
        <h3 style="color: #667eea; margin-bottom: 20px;">üí° Exemplos de Temas Populares</h3>
    </div>
    """, unsafe_allow_html=True)
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        <div class="feature-card">
            <h4>üìà Neg√≥cios & Empreendedorismo</h4>
            <ul>
                <li>Marketing Digital para PMEs</li>
                <li>Gest√£o de Equipes Remotas</li>
                <li>Estrat√©gias de Vendas B2B</li>
                <li>Planejamento Financeiro Empresarial</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)
        
        st.markdown("""
        <div class="feature-card">
            <h4>üõ†Ô∏è Tecnologia & Desenvolvimento</h4>
            <ul>
                <li>Introdu√ß√£o √† Programa√ß√£o Python</li>
                <li>Desenvolvimento de Apps Mobile</li>
                <li>Intelig√™ncia Artificial Aplicada</li>
                <li>Seguran√ßa em Sistemas Web</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown("""
        <div class="feature-card">
            <h4>üí° Desenvolvimento Pessoal</h4>
            <ul>
                <li>Produtividade e Gest√£o do Tempo</li>
                <li>Comunica√ß√£o Eficaz</li>
                <li>Lideran√ßa e Influ√™ncia</li>
                <li>Mindfulness e Bem-estar</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)
        
        st.markdown("""
        <div class="feature-card">
            <h4>üéì Educa√ß√£o & Conhecimento</h4>
            <ul>
                <li>Hist√≥ria Mundial Contempor√¢nea</li>
                <li>Ci√™ncias para Leigos</li>
                <li>Filosofia Aplicada ao Cotidiano</li>
                <li>Arte e Cultura Brasileira</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)

def create_tips_section():
    """Cria se√ß√£o com dicas"""
    st.markdown("""
    <div class="glass-card fade-in">
        <h3 style="color: #667eea; margin-bottom: 20px;">üéØ Dicas para Resultados Excepcionais</h3>
    </div>
    """, unsafe_allow_html=True)
    
    tips = [
        ("üéØ", "Seja Espec√≠fico", "Quanto mais detalhado o t√≥pico, melhor o resultado final"),
        ("üë•", "Conhe√ßa seu P√∫blico", "Defina claramente quem s√£o seus leitores ideais"),
        ("üìä", "Use Dados Reais", "Mencione se precisa de estat√≠sticas ou pesquisas atuais"),
        ("üíº", "Inclua Casos Pr√°ticos", "Solicite exemplos reais e estudos de caso"),
        ("üîÑ", "Itera√ß√£o √© Chave", "Use as op√ß√µes avan√ßadas para refinar o conte√∫do"),
        ("üì±", "Pense Mobile", "Considere como o conte√∫do ser√° consumido pelos leitores")
    ]
    
    for icon, title, description in tips:
        st.markdown(f"""
        <div class="feature-card">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 1.5em; margin-right: 15px;">{icon}</span>
                <strong style="color: #667eea;">{title}</strong>
            </div>
            <p style="margin: 0; color: #8b92a5;">{description}</p>
        </div>
        """, unsafe_allow_html=True)

def get_default_params():
    """Retorna par√¢metros padr√£o para evitar campos faltantes"""
    return {
        "topic": "T√≥pico n√£o especificado",
        "style": "Profissional",
        "pages": 25,
        "length": 25,  # Alias para pages
        "target_audience": "Adultos interessados no tema",
        "depth_level": "Intermedi√°rio com exemplos pr√°ticos",
        "main_objective": "Educar sobre o tema de forma clara e pr√°tica",
        "audience": "Adultos interessados no tema",  # Alias para target_audience
        "difficulty": "Intermedi√°rio",
        "tone": "Conversacional",
        "focus": "Balanceado",
        "key_points": "",
        "special_requirements": "",
        "language": "üáßüá∑ Portugu√™s",
        "include_images": True,
        "include_exercises": True,
        "book_type": "üìì Educacional"
    }

def validate_and_prepare_params(form_data, config):
    """Valida e prepara par√¢metros com sistema robusto de fallback"""
    
    # Come√ßar com par√¢metros padr√£o
    params = get_default_params()
    
    # Mapear tipos de livro para objetivos principais
    objective_mapping = {
        "üìà Neg√≥cios": "Ensinar estrat√©gias e pr√°ticas de neg√≥cios eficazes para aplica√ß√£o pr√°tica",
        "üõ†Ô∏è T√©cnico": "Explicar conceitos t√©cnicos de forma clara, did√°tica e aplic√°vel",
        "üí° Autoajuda": "Inspirar e guiar o desenvolvimento pessoal atrav√©s de t√©cnicas comprovadas",
        "üéì Educacional": "Educar e informar sobre o tema de forma did√°tica e estruturada",
        "üìù Narrativo": "Contar uma hist√≥ria envolvente e significativa que eduque e inspire"
    }
    
    # Mapear dificuldade para depth_level
    depth_mapping = {
        "Iniciante": "B√°sico e acess√≠vel, com explica√ß√µes detalhadas de conceitos fundamentais",
        "Intermedi√°rio": "Intermedi√°rio com exemplos pr√°ticos e aplica√ß√µes reais",
        "Avan√ßado": "Avan√ßado com an√°lises profundas e casos complexos",
        "Especialista": "Especialista com insights t√©cnicos e abordagem cient√≠fica"
    }
    
    # Mapear idioma
    language_mapping = {
        "üáßüá∑ Portugu√™s": "portugu√™s brasileiro",
        "üá∫üá∏ Ingl√™s": "ingl√™s",
        "üá™üá∏ Espanhol": "espanhol",
        "üá´üá∑ Franc√™s": "franc√™s"
    }
    
    try:
        # Atualizar com dados do formul√°rio, usando fallbacks seguros
        if form_data.get("topic") and form_data["topic"].strip():
            params["topic"] = form_data["topic"].strip()
        
        if form_data.get("audience") and form_data["audience"].strip():
            params["target_audience"] = form_data["audience"].strip()
            params["audience"] = form_data["audience"].strip()
        
        if form_data.get("difficulty"):
            params["difficulty"] = form_data["difficulty"]
            params["depth_level"] = depth_mapping.get(
                form_data["difficulty"], 
                "Intermedi√°rio com exemplos pr√°ticos"
            )
        
        if form_data.get("tone"):
            params["tone"] = form_data["tone"]
        
        if form_data.get("focus"):
            params["focus"] = form_data["focus"]
        
        if form_data.get("key_points") and form_data["key_points"].strip():
            params["key_points"] = form_data["key_points"].strip()
        
        if form_data.get("special_requirements") and form_data["special_requirements"].strip():
            params["special_requirements"] = form_data["special_requirements"].strip()
        
        # Atualizar com configura√ß√µes
        if config.get("style"):
            params["style"] = config["style"]
        
        if config.get("pages"):
            params["pages"] = config["pages"]
            params["length"] = config["pages"]  # Alias
        
        if config.get("language"):
            params["language"] = language_mapping.get(
                config["language"], 
                "portugu√™s brasileiro"
            )
        
        if config.get("book_type"):
            params["book_type"] = config["book_type"]
            params["main_objective"] = objective_mapping.get(
                config["book_type"], 
                "Educar sobre o tema de forma clara e pr√°tica"
            )
        
        # Par√¢metros booleanos
        params["include_images"] = config.get("include_images", True)
        params["include_exercises"] = config.get("include_exercises", True)
        
        # Log dos par√¢metros para debug
        st.write("üîç **Par√¢metros preparados:**")
        debug_params = {k: v for k, v in params.items() if k in [
            "topic", "style", "pages", "target_audience", "depth_level", 
            "main_objective", "difficulty", "tone", "focus"
        ]}
        st.json(debug_params)
        
        return params
        
    except Exception as e:
        st.error(f"‚ö†Ô∏è Erro na prepara√ß√£o dos par√¢metros: {str(e)}")
        st.error("üìã Usando par√¢metros padr√£o...")
        return params

def get_required_chain_params():
    """Retorna os par√¢metros essenciais que as chains precisam"""
    return {
        "outline_required": [
            "topic", "style", "length", "target_audience", 
            "depth_level", "main_objective"
        ],
        "writing_required": [
            "outline", "topic", "style", "target_audience", 
            "depth_level", "main_objective"
        ]
    }

def create_ebook_chain(llm):
    """Cria a cadeia completa de gera√ß√£o de ebooks com valida√ß√£o robusta"""
    
    try:
        outline_chain = create_outline_chain(llm)
        writing_chain = create_writing_chain(llm)
    except Exception as e:
        st.error(f"‚ùå Erro ao inicializar chains: {str(e)}")
        raise e
    
    def combined_chain(**params):
        """Chain combinada com tratamento robusto de erros"""
        
        # Obter par√¢metros obrigat√≥rios
        required_params = get_required_chain_params()
        
        # Preparar par√¢metros m√≠nimos para outline
        outline_params = {}
        
        for param in required_params["outline_required"]:
            if param in params and params[param] is not None:
                outline_params[param] = params[param]
            else:
                # Usar defaults se par√¢metro n√£o existir
                defaults = get_default_params()
                if param in defaults:
                    outline_params[param] = defaults[param]
                    st.warning(f"‚ö†Ô∏è Usando valor padr√£o para '{param}': {defaults[param]}")
        
        # Log dos par√¢metros do outline
        st.write("üìã **Par√¢metros para gera√ß√£o da estrutura:**")
        st.json({k: str(v)[:100] + "..." if len(str(v)) > 100 else v 
                for k, v in outline_params.items()})
        
        # Gerar outline com tratamento de erro
        try:
            st.info("üîç Gerando estrutura do ebook...")
            outline = outline_chain.run(**outline_params)
            st.success("‚úÖ Estrutura gerada com sucesso!")
            
        except Exception as e:
            st.error(f"‚ùå Erro na gera√ß√£o da estrutura: {str(e)}")
            
            # Fallback: tentar com par√¢metros m√≠nimos
            minimal_params = {
                "topic": outline_params.get("topic", "T√≥pico Geral"),
                "style": outline_params.get("style", "Profissional"),
                "length": outline_params.get("length", 25)
            }
            
            st.warning("üîÑ Tentando com par√¢metros m√≠nimos...")
            try:
                outline = outline_chain.run(**minimal_params)
                st.success("‚úÖ Estrutura gerada com par√¢metros simplificados!")
            except Exception as e2:
                st.error(f"‚ùå Falha cr√≠tica na gera√ß√£o da estrutura: {str(e2)}")
                return f"Erro na gera√ß√£o do ebook: {str(e2)}"
        
        # Preparar par√¢metros para escrita
        writing_params = {
            "outline": outline,
            "topic": params.get("topic", "T√≥pico n√£o especificado"),
            "style": params.get("style", "Profissional"),
            "target_audience": params.get("target_audience", "Adultos interessados no tema"),
            "depth_level": params.get("depth_level", "Intermedi√°rio com exemplos pr√°ticos"),
            "main_objective": params.get("main_objective", "Educar sobre o tema de forma clara")
        }
        
        # Adicionar par√¢metros opcionais se existirem
        optional_params = ["tone", "focus", "key_points", "special_requirements", 
                          "language", "include_images", "include_exercises"]
        
        for param in optional_params:
            if param in params and params[param] is not None and str(params[param]).strip():
                writing_params[param] = params[param]
        
        # Log dos par√¢metros de escrita
        st.write("‚úçÔ∏è **Par√¢metros para gera√ß√£o do conte√∫do:**")
        st.json({k: str(v)[:100] + "..." if len(str(v)) > 100 else v 
                for k, v in writing_params.items()})
        
        # Gerar conte√∫do com tratamento de erro
        try:
            st.info("‚úçÔ∏è Gerando conte√∫do do ebook...")
            ebook = writing_chain.run(**writing_params)
            st.success("‚úÖ Ebook gerado com sucesso!")
            return ebook
            
        except Exception as e:
            st.error(f"‚ùå Erro na gera√ß√£o do conte√∫do: {str(e)}")
            
            # Fallback: tentar com par√¢metros m√≠nimos
            minimal_writing_params = {
                "outline": outline,
                "topic": writing_params["topic"],
                "style": writing_params["style"]
            }
            
            st.warning("üîÑ Tentando gera√ß√£o simplificada...")
            try:
                ebook = writing_chain.run(**minimal_writing_params)
                st.success("‚úÖ Conte√∫do gerado com par√¢metros simplificados!")
                return ebook
            except Exception as e2:
                st.error(f"‚ùå Falha cr√≠tica na gera√ß√£o do conte√∫do: {str(e2)}")
                return f"Erro na gera√ß√£o do ebook: {str(e2)}"
    
    return combined_chain

def display_generation_progress():
    """Exibe progresso da gera√ß√£o com anima√ß√£o"""
    progress_steps = [
        ("üîç", "Analisando o t√≥pico..."),
        ("üìã", "Criando estrutura do ebook..."),
        ("‚úçÔ∏è", "Gerando conte√∫do dos cap√≠tulos..."),
        ("üé®", "Formatando e organizando..."),
        ("üìÑ", "Finalizando o documento..."),
        ("‚úÖ", "Ebook conclu√≠do!")
    ]
    
    progress_bar = st.progress(0)
    status_text = st.empty()
    
    for i, (icon, message) in enumerate(progress_steps):
        progress = (i + 1) / len(progress_steps)
        progress_bar.progress(progress)
        status_text.markdown(f"""
        <div style="text-align: center; padding: 10px;">
            <span style="font-size: 2em;">{icon}</span>
            <p style="margin: 10px 0; color: #667eea; font-weight: 600;">{message}</p>
        </div>
        """, unsafe_allow_html=True)
        
        # Simula tempo de processamento
        import time
        time.sleep(1)
    
    return progress_bar, status_text

def display_results(ebook_content, config, form_data):
    """Exibe os resultados da gera√ß√£o"""
    # Atualizar estat√≠sticas
    st.session_state.ebooks_generated = st.session_state.get("ebooks_generated", 0) + 1
    st.session_state.total_pages = st.session_state.get("total_pages", 0) + config["pages"]
    
    # Mensagem de sucesso
    st.markdown("""
    <div class="glass-card fade-in" style="text-align: center;">
        <h2 style="color: #10b981; margin-bottom: 20px;">üéâ Ebook Gerado com Sucesso!</h2>
        <p style="color: #8b92a5;">Seu ebook profissional est√° pronto para download e visualiza√ß√£o.</p>
    </div>
    """, unsafe_allow_html=True)
    
    # M√©tricas do ebook gerado
    col1, col2, col3, col4 = st.columns(4)
    
    word_count = len(ebook_content.split())
    char_count = len(ebook_content)
    estimated_reading_time = max(1, word_count // 200)  # ~200 palavras por minuto
    
    with col1:
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-value">{config["pages"]}</div>
            <div class="metric-label">P√°ginas</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-value">{word_count:,}</div>
            <div class="metric-label">Palavras</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col3:
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-value">{estimated_reading_time}</div>
            <div class="metric-label">Min. Leitura</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col4:
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-value">{config["format"].split()[1]}</div>
            <div class="metric-label">Formato</div>
        </div>
        """, unsafe_allow_html=True)
    
    # Tabs para visualiza√ß√£o e download
    tab1, tab2, tab3 = st.tabs(["üìñ Visualizar", "‚¨áÔ∏è Download", "üìä Detalhes"])
    
    with tab1:
        st.markdown('<div class="custom-card">', unsafe_allow_html=True)
        st.markdown(ebook_content)
        st.markdown('</div>', unsafe_allow_html=True)
    
    with tab2:
        col1, col2 = st.columns([2, 1])
        
        with col1:
            # Gerar arquivo para download
            try:
                ebook_path = save_ebook(
                    content=ebook_content,
                    title=form_data["topic"][:50],
                    format=config["format"].lower().split()[1]
                )
                
                with open(ebook_path, "rb") as f:
                    file_data = f.read()
                
                filename = f"ebook_{form_data['topic'][:30].replace(' ', '_')}_{datetime.now().strftime('%Y%m%d_%H%M')}"
                file_extension = config["format"].lower().split()[1]
                
                mime_types = {
                    "pdf": "application/pdf",
                    "markdown": "text/markdown",
                    "html": "text/html",
                    "epub": "application/epub+zip"
                }
                
                st.download_button(
                    label=f"üì• Baixar Ebook ({config['format']})",
                    data=file_data,
                    file_name=f"{filename}.{file_extension}",
                    mime=mime_types.get(file_extension, "text/plain"),
                    use_container_width=True
                )
                
                st.success(f"‚úÖ Arquivo salvo como: {filename}.{file_extension}")
                
            except Exception as e:
                st.error(f"‚ùå Erro ao preparar download: {str(e)}")
                
                # Fallback: oferecer download direto do texto
                st.download_button(
                    label="üìù Baixar como Texto",
                    data=ebook_content,
                    file_name=f"ebook_{datetime.now().strftime('%Y%m%d_%H%M')}.txt",
                    mime="text/plain",
                    use_container_width=True
                )
        
        with col2:
            st.info("""
            **üìã Formatos Dispon√≠veis:**
            
            ‚Ä¢ **PDF**: Melhor para leitura
            ‚Ä¢ **Markdown**: Edit√°vel 
            ‚Ä¢ **HTML**: Web-friendly
            ‚Ä¢ **EPUB**: E-readers
            """)
    
    with tab3:
        st.markdown("### üìä Informa√ß√µes Detalhadas")
        
        details = {
            "üéØ T√≥pico": form_data["topic"],
            "üìö Tipo de Livro": config["book_type"],
            "‚úçÔ∏è Estilo": config["style"],
            "üë• P√∫blico-alvo": form_data["audience"],
            "üìä N√≠vel": form_data["difficulty"],
            "üé≠ Tom": form_data["tone"],
            "üéØ Foco": form_data["focus"],
            "üåç Idioma": config["language"],
            "üíæ Formato": config["format"],
            "üìÑ P√°ginas": config["pages"],
            "üìù Palavras": f"{word_count:,}",
            "‚è±Ô∏è Tempo de Leitura": f"{estimated_reading_time} minutos",
            "üìÖ Gerado em": datetime.now().strftime("%d/%m/%Y √†s %H:%M")
        }
        
        for key, value in details.items():
            st.markdown(f"**{key}:** {value}")

def main():
    """Fun√ß√£o principal da aplica√ß√£o"""
    # Configura√ß√£o da p√°gina
    st.set_page_config(
        page_title="üìö EBook Generator Pro",
        page_icon="üìö",
        layout="wide",
        initial_sidebar_state="expanded",
        menu_items={
            'Get Help': 'https://github.com/seu-usuario/ebook-generator',
            'Report a bug': "https://github.com/seu-usuario/ebook-generator/issues",
            'About': "# EBook Generator Pro\nGerador profissional de ebooks com IA"
        }
    )
    
    # Aplicar tema escuro
    apply_dark_theme()
    
    # Inicializar session state
    if "ebooks_generated" not in st.session_state:
        st.session_state.ebooks_generated = 0
    if "total_pages" not in st.session_state:
        st.session_state.total_pages = 0
    
    # Header principal
    create_header()
    
    # Layout principal
    # Sidebar com configura√ß√µes
    config = create_sidebar()
    
    # Conte√∫do principal
    col1, col2 = st.columns([2, 1])
    
    with col1:
        # Formul√°rio principal
        form_data = create_main_form()
        
        # Processamento da gera√ß√£o
        if form_data["submit"] and form_data["topic"]:
            if not config["api_key"]:
                st.error("‚ö†Ô∏è Por favor, configure sua OpenAI API Key na barra lateral")
                st.stop()
            
            # Valida√ß√£o b√°sica do t√≥pico
            if len(form_data["topic"].strip()) < 10:
                st.warning("‚ö†Ô∏è Por favor, forne√ßa uma descri√ß√£o mais detalhada do t√≥pico (m√≠nimo 10 caracteres)")
                st.stop()
            
            try:
                # Container para o progresso
                with st.container():
                    st.markdown("""
                    <div class="glass-card fade-in">
                        <h3 style="color: #667eea; text-align: center;">üöÄ Gerando seu Ebook...</h3>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Preparar e validar par√¢metros ANTES de inicializar chains
                    with st.expander("üîß Diagn√≥stico de Par√¢metros", expanded=False):
                        generation_params = validate_and_prepare_params(form_data, config)
                    
                    # Mostrar progresso
                    progress_container = st.empty()
                    
                    with progress_container.container():
                        progress_bar, status_text = display_generation_progress()
                    
                    # Configurar LLM com tratamento de erro
                    try:
                        llm = OpenAI(
                            openai_api_key=config["api_key"],
                            temperature=0.7,
                            max_tokens=4000,
                            request_timeout=120  # 2 minutos de timeout
                        )
                        st.success("‚úÖ LLM configurado com sucesso!")
                    except Exception as e:
                        st.error(f"‚ùå Erro na configura√ß√£o da API OpenAI: {str(e)}")
                        st.error("üîë Verifique se sua API Key est√° correta e v√°lida")
                        st.stop()
                    
                    # Criar cadeia de gera√ß√£o com tratamento de erro
                    try:
                        ebook_chain = create_ebook_chain(llm)
                        st.success("‚úÖ Sistema de gera√ß√£o inicializado!")
                    except Exception as e:
                        st.error(f"‚ùå Erro na inicializa√ß√£o do sistema: {str(e)}")
                        st.exception(e)
                        st.stop()
                    
                    # Gerar ebook com par√¢metros validados
                    try:
                        ebook_content = ebook_chain(**generation_params)
                        
                        # Verificar se o conte√∫do foi gerado com sucesso
                        if not ebook_content or len(ebook_content.strip()) < 100:
                            st.error("‚ùå Conte√∫do gerado √© muito curto ou vazio")
                            st.error("üìù Tente novamente com uma descri√ß√£o mais espec√≠fica do t√≥pico")
                            st.stop()
                        
                        st.success("üéâ Ebook gerado com sucesso!")
                        
                    except Exception as e:
                        st.error(f"‚ùå Erro durante a gera√ß√£o do ebook: {str(e)}")
                        
                        # Mostrar detalhes do erro em modo debug
                        with st.expander("üîç Detalhes do Erro (Debug)", expanded=False):
                            st.code(traceback.format_exc())
                        
                        st.error("üîÑ Sugest√µes para resolver:")
                        st.error("‚Ä¢ Verifique sua conex√£o com a internet")
                        st.error("‚Ä¢ Tente reduzir o n√∫mero de p√°ginas")
                        st.error("‚Ä¢ Simplifique a descri√ß√£o do t√≥pico")
                        st.error("‚Ä¢ Verifique se sua API Key tem cr√©ditos suficientes")
                        st.stop()
                    
                    # Limpar progresso
                    progress_container.empty()
                    
                    # Exibir resultados
                    display_results(ebook_content, config, form_data)
                    
            except Exception as e:
                st.error(f"‚ùå Erro cr√≠tico na aplica√ß√£o: {str(e)}")
                
                # Debug completo
                with st.expander("üêõ Debug Completo", expanded=False):
                    st.code(traceback.format_exc())
                
                # Sugest√µes de solu√ß√£o
                st.markdown("""
                <div class="glass-card">
                    <h4 style="color: #ef4444;">üîß Poss√≠veis Solu√ß√µes:</h4>
                    <ul>
                        <li><strong>API Key:</strong> Verifique se sua chave OpenAI est√° correta e tem cr√©ditos</li>
                        <li><strong>Conectividade:</strong> Teste sua conex√£o com a internet</li>
                        <li><strong>Par√¢metros:</strong> Tente simplificar as configura√ß√µes do ebook</li>
                        <li><strong>T√≥pico:</strong> Use uma descri√ß√£o mais clara e espec√≠fica</li>
                        <li><strong>Reiniciar:</strong> Recarregue a p√°gina e tente novamente</li>
                    </ul>
                </div>
                """, unsafe_allow_html=True)
        
        elif form_data["submit"] and not form_data["topic"]:
            st.warning("üìù Por favor, descreva o tema do seu ebook antes de continuar.")
    
    with col2:
        # Se√ß√£o de exemplos
        create_example_section()
        
        # Se√ß√£o de dicas
        create_tips_section()
        
        # Se√ß√£o de recursos
        st.markdown("""
        <div class="glass-card fade-in">
            <h3 style="color: #667eea; margin-bottom: 20px;">üéÅ Recursos Inclusos</h3>
            <div class="feature-card">
                <h4>‚ú® Conte√∫do Profissional</h4>
                <p style="color: #8b92a5;">Estrutura completa com introdu√ß√£o, cap√≠tulos organizados e conclus√£o impactante.</p>
            </div>
            <div class="feature-card">
                <h4>üñºÔ∏è Sugest√µes Visuais</h4>
                <p style="color: #8b92a5;">Descri√ß√µes de imagens e gr√°ficos para enriquecer seu ebook.</p>
            </div>
            <div class="feature-card">
                <h4>üìö Exerc√≠cios Pr√°ticos</h4>
                <p style="color: #8b92a5;">Atividades e reflex√µes para engajar seus leitores.</p>
            </div>
            <div class="feature-card">
                <h4>üìÑ M√∫ltiplos Formatos</h4>
                <p style="color: #8b92a5;">PDF, Markdown, HTML e EPUB para m√°xima compatibilidade.</p>
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        # Se√ß√£o de suporte
        st.markdown("""
        <div class="glass-card fade-in">
            <h3 style="color: #667eea; margin-bottom: 20px;">üí¨ Suporte & Ajuda</h3>
            <div style="text-align: center;">
                <p style="color: #8b92a5; margin-bottom: 20px;">Precisa de ajuda ou tem sugest√µes?</p>
                <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                    <a href="mailto:suporte@ebookgenerator.com" style="color: #667eea; text-decoration: none;">
                        üìß Email
                    </a>
                    <a href="https://github.com/seu-usuario/ebook-generator" style="color: #667eea; text-decoration: none;">
                        üê± GitHub
                    </a>
                    <a href="https://discord.gg/seu-servidor" style="color: #667eea; text-decoration: none;">
                        üí¨ Discord
                    </a>
                </div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style="text-align: center; padding: 20px 0; color: #8b92a5;">
        <p>üìö <strong>EBook Generator Pro</strong> - Powered by OpenAI GPT</p>
        <p style="font-size: 0.8em;">Vers√£o 2.0 | ¬© 2024 | Feito com ‚ù§Ô∏è para criadores de conte√∫do</p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()